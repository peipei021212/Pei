
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è»’ & ä½©å°ˆå±¬ APP</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-dark {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Gradient Background */
        .bg-gradient-main {
            background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            background-attachment: fixed;
        }

        /* Identity Themes */
        .theme-peipei .accent-color { color: #9F7AEA; }
        .theme-peipei .accent-bg { background-color: #9F7AEA; }
        .theme-peipei .accent-border { border-color: #9F7AEA; }
        
        .theme-haoxuan .accent-color { color: #63B3ED; }
        .theme-haoxuan .accent-bg { background-color: #63B3ED; }
        .theme-haoxuan .accent-border { border-color: #63B3ED; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }

        /* Mobile Optimizations */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        .hidden-page { display: none; }
        .active-page { display: block; }
    </style>
</head>
<body class="bg-gradient-main text-gray-700 h-screen overflow-hidden flex flex-col">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-sm transition-opacity duration-500">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p class="text-gray-500">æ­£åœ¨åŒæ­¥æ„›çš„æ•¸æ“š...</p>
        </div>
    </div>

    <!-- Login/Cover Page -->
    <div id="login-page" class="fixed inset-0 z-40 flex flex-col items-center justify-center p-6 glass active-page">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800 mb-2 drop-shadow-sm">è»’ & ä½©</h1>
            <p class="text-lg text-gray-600 tracking-widest">å°ˆå±¬ APP</p>
        </div>

        <div class="w-full max-w-sm space-y-6">
            <div class="text-center mb-4">
                <p class="text-gray-500 text-sm mb-4">è«‹é¸æ“‡æ‚¨çš„èº«ä»½</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="selectUser('peipei')" id="btn-user-peipei" class="p-6 rounded-2xl bg-white shadow-lg border-2 border-transparent hover:border-purple-300 transition-all transform hover:scale-105">
                        <div class="text-4xl mb-2">ğŸ€</div>
                        <div class="font-bold text-gray-700">ä½©ä½©</div>
                    </button>
                    <button onclick="selectUser('haoxuan')" id="btn-user-haoxuan" class="p-6 rounded-2xl bg-white shadow-lg border-2 border-transparent hover:border-blue-300 transition-all transform hover:scale-105">
                        <div class="text-4xl mb-2">ğŸ»</div>
                        <div class="font-bold text-gray-700">æµ©è»’</div>
                    </button>
                </div>
            </div>

            <div id="pin-section" class="hidden animate-fade-in bg-white/60 p-6 rounded-2xl">
                <p class="text-center text-gray-600 mb-4" id="pin-instruction">è«‹è¼¸å…¥ PIN ç¢¼</p>
                <div class="flex justify-center gap-3 mb-6">
                    <input type="password" id="pin-input" maxlength="4" class="text-center text-2xl tracking-widest w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80" inputmode="numeric" placeholder="****">
                </div>
                <button onclick="verifyPin()" class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-500 to-blue-500 text-white font-bold shadow-md active:scale-95 transition-transform">
                    é€²å…¥æ„›çš„å°çª©
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Interface (Hidden by default) -->
    <div id="main-app" class="hidden flex-col h-full w-full">
        
        <!-- Header -->
        <header class="pt-safe px-4 pb-2 glass-dark z-30 flex justify-between items-center shadow-sm">
            <div>
                <h2 class="text-lg font-bold" id="header-title">ä½©ã®å°ˆå±¬</h2>
                <p class="text-xs text-gray-500" id="current-user-display">ç•¶å‰ç™»å…¥: ä½©ä½©</p>
            </div>
            <button onclick="openSettings()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500">
                <i class="fas fa-cog"></i>
            </button>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth relative" id="content-area">
            
            <!-- Tab 1: Peipei's List (Reimbursement & Wish) -->
            <div id="view-peipei" class="hidden-page animate-fade-in space-y-6">
                <!-- Reimbursement Section -->
                <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-purple-600 flex items-center gap-2"><i class="fas fa-file-invoice-dollar"></i> å ±éŠ·å€</h3>
                        <button onclick="openModal('add-reimburse')" class="text-sm bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-medium">+ æ–°å¢</button>
                    </div>
                    <div id="list-reimbursements" class="space-y-3">
                        <!-- Items injected by JS -->
                    </div>
                </section>

                <!-- Wish Pool Section -->
                <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-pink-500 flex items-center gap-2"><i class="fas fa-wand-magic-sparkles"></i> ä½©ã®è¨±é¡˜æ± </h3>
                        <button onclick="openModal('add-wish-peipei')" class="text-sm bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-medium">+ è¨±é¡˜</button>
                    </div>
                    <div id="list-wishes-peipei" class="grid grid-cols-2 gap-3">
                        <!-- Items injected by JS -->
                    </div>
                </section>
            </div>

            <!-- Tab 2: Haoxuan's List (Wish Only) -->
            <div id="view-haoxuan" class="hidden-page animate-fade-in space-y-6">
                 <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i class="fas fa-star"></i> è»’ã®è¨±é¡˜æ± </h3>
                        <button onclick="openModal('add-wish-haoxuan')" class="text-sm bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-medium">+ è¨±é¡˜</button>
                    </div>
                    <div id="list-wishes-haoxuan" class="grid grid-cols-2 gap-3">
                        <!-- Items injected by JS -->
                    </div>
                </section>
            </div>

            <!-- Tab 3: Family Expense & Shopping -->
            <div id="view-family" class="hidden-page animate-fade-in space-y-6">
                <!-- Shopping List -->
                <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-green-600 flex items-center gap-2"><i class="fas fa-shopping-cart"></i> å¾…è³¼æ¸…å–®</h3>
                        <button onclick="openModal('add-shopping')" class="text-sm bg-green-100 text-green-600 px-3 py-1 rounded-full font-medium">+ æ–°å¢</button>
                    </div>
                    <div id="list-shopping" class="space-y-2">
                        <!-- Items injected by JS -->
                    </div>
                </section>

                <!-- Expense Record -->
                <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2"><i class="fas fa-calculator"></i> å®¶åº­è¨˜å¸³</h3>
                        <button onclick="openModal('add-expense')" class="text-sm bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-medium">+ è¨˜ä¸€ç­†</button>
                    </div>
                    <div class="text-xs text-gray-400 mb-2 flex justify-between">
                        <span>é …ç›®</span>
                        <span>é‡‘é¡</span>
                    </div>
                    <div id="list-expenses" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Items injected by JS -->
                    </div>
                </section>
            </div>

            <!-- Tab 4: Dream Fund -->
            <div id="view-dream" class="hidden-page animate-fade-in space-y-6">
                <section class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white text-center">
                    <p class="text-indigo-100 text-sm mb-1">ç›®å‰ç´¯ç©åŸºé‡‘</p>
                    <h2 class="text-4xl font-bold tracking-tight mb-4" id="dream-total">NT$ 0</h2>
                    <button onclick="openModal('add-dream')" class="bg-white/20 hover:bg-white/30 backdrop-blur text-white px-6 py-2 rounded-full transition-colors">
                        <i class="fas fa-coins mr-1"></i> å­˜å…¥/æ”¯å‡º
                    </button>
                </section>

                <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-history"></i> è®Šå‹•ç´€éŒ„</h3>
                    <div id="list-dream" class="space-y-3">
                        <!-- Items injected by JS -->
                    </div>
                </section>
            </div>

            <!-- Tab 5: Requests -->
            <div id="view-requests" class="hidden-page animate-fade-in space-y-6">
                <section class="bg-white/80 rounded-2xl shadow-sm p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-clipboard-check"></i> éœ€æ±‚ç”³è«‹å–®</h3>
                        <button onclick="openModal('add-request')" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-full font-medium">+ æå‡ºç”³è«‹</button>
                    </div>
                    <div id="list-requests" class="space-y-4">
                        <!-- Items injected by JS -->
                    </div>
                </section>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 glass-dark pb-safe pt-2 px-2 border-t border-white/40 z-40 flex justify-around items-end shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
            <button onclick="switchTab('peipei')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-300" id="nav-peipei">
                <span class="text-2xl mb-1 transform transition-transform">ğŸ€</span>
                <span class="text-[10px] font-medium text-gray-500">ä½©ã®æ¸…å–®</span>
            </button>
            <button onclick="switchTab('haoxuan')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-300" id="nav-haoxuan">
                <span class="text-2xl mb-1 transform transition-transform">ğŸ»</span>
                <span class="text-[10px] font-medium text-gray-500">è»’ã®æ¸…å–®</span>
            </button>
            <button onclick="switchTab('family')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-300" id="nav-family">
                <span class="text-2xl mb-1 transform transition-transform">ğŸ¡</span>
                <span class="text-[10px] font-medium text-gray-500">å®¶åº­é–‹æ”¯</span>
            </button>
            <button onclick="switchTab('dream')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-300" id="nav-dream">
                <span class="text-2xl mb-1 transform transition-transform">ğŸ’</span>
                <span class="text-[10px] font-medium text-gray-500">å¤¢æƒ³åŸºé‡‘</span>
            </button>
            <button onclick="switchTab('requests')" class="nav-btn flex flex-col items-center p-2 w-1/5 transition-all duration-300" id="nav-requests">
                <span class="text-2xl mb-1 transform transition-transform">ğŸ“</span>
                <span class="text-[10px] font-medium text-gray-500">ç”³è«‹å–®</span>
            </button>
        </nav>
    </div>

    <!-- Modals (Generic Structure) -->
    <div id="modal-overlay" class="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
        <!-- Content injected by JS -->
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_ibqjVqz5YGMhNBqDNMTKjoah_cis1x4",
            authDomain: "peipei-9340e.firebaseapp.com",
            projectId: "peipei-9340e",
            storageBucket: "peipei-9340e.firebasestorage.app",
            messagingSenderId: "265456201682",
            appId: "1:265456201682:web:a42736be9dfac54db6620b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUser = null; // 'peipei' or 'haoxuan'
        let currentTab = 'peipei';
        let defaultPins = { peipei: '0516', haoxuan: '0202' };
        let currentPins = { ...defaultPins };
        const appId = 'couple-app-v1'; // Namespace for artifacts

        // --- Helper: DB References ---
        // Using "public" path as per rules, using collections to separate data types
        const getColl = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        
        // --- Initialization ---
        async function init() {
            try {
                await signInAnonymously(auth);
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                
                // Load Settings (PINs)
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentPins = docSnap.data();
                    } else {
                        // Init settings if not exist
                        setDoc(settingsRef, defaultPins);
                    }
                });

                // Start Listeners
                startListeners();
            } catch (e) {
                console.error("Init Error", e);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        }

        function startListeners() {
            // Reimbursements
            onSnapshot(query(getColl('reimbursements'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-reimbursements');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isPaid = data.status === 'paid';
                    const canAction = currentUser === 'haoxuan' && !isPaid;
                    
                    list.innerHTML += `
                        <div class="bg-white border-l-4 ${isPaid ? 'border-gray-300 opacity-60' : 'border-purple-400'} rounded-lg p-3 shadow-sm flex justify-between items-center">
                            <div>
                                <div class="font-bold text-gray-800">${data.title}</div>
                                <div class="text-sm text-gray-500">$${data.amount} <span class="text-xs ml-2">${new Date(data.date).toLocaleDateString()}</span></div>
                            </div>
                            ${canAction ? 
                                `<button onclick="window.payReimburse('${d.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-200">æ ¸éŠ·</button>` : 
                                (isPaid ? `<span class="text-green-500 text-xs font-bold"><i class="fas fa-check"></i> å·²æ ¸éŠ·</span>` : `<button onclick="window.deleteItem('reimbursements', '${d.id}')" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash"></i></button>`)
                            }
                        </div>`;
                });
            });

            // Peipei Wishes
            onSnapshot(query(getColl('peipei_wishes'), orderBy('date', 'desc')), snap => renderWishes(snap, 'list-wishes-peipei', 'peipei'));
            
            // Haoxuan Wishes
            onSnapshot(query(getColl('haoxuan_wishes'), orderBy('date', 'desc')), snap => renderWishes(snap, 'list-wishes-haoxuan', 'haoxuan'));

            // Shopping List
            onSnapshot(query(getColl('shopping_list'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-shopping');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `
                        <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                            <input type="checkbox" ${data.checked ? 'checked' : ''} onchange="window.toggleCheck('shopping_list', '${d.id}', this.checked)" class="w-5 h-5 text-green-500 rounded focus:ring-green-500 border-gray-300">
                            <span class="ml-3 flex-1 ${data.checked ? 'line-through text-gray-400' : 'text-gray-700 font-medium'}">${data.item}</span>
                            <button onclick="window.deleteItem('shopping_list', '${d.id}')" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
            });

            // Family Expenses
            onSnapshot(query(getColl('family_expenses'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-expenses');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                            <span class="text-gray-700">${data.title}</span>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-gray-800">$${data.amount}</span>
                                <button onclick="window.deleteItem('family_expenses', '${d.id}')" class="text-gray-300 text-xs"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                });
            });

            // Dream Fund
            onSnapshot(query(getColl('dream_fund'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-dream');
                let total = 0;
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const amount = parseInt(data.amount);
                    total += amount;
                    const isDeposit = amount > 0;
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border-l-4 ${isDeposit ? 'border-indigo-400' : 'border-pink-400'}">
                            <div>
                                <div class="font-bold text-gray-800">${data.note}</div>
                                <div class="text-xs text-gray-500">${new Date(data.date).toLocaleDateString()}</div>
                            </div>
                            <span class="font-bold ${isDeposit ? 'text-indigo-600' : 'text-pink-600'}">${amount > 0 ? '+' : ''}${amount}</span>
                        </div>`;
                });
                document.getElementById('dream-total').innerText = `NT$ ${total.toLocaleString()}`;
            });

            // Requests
            onSnapshot(query(getColl('requests'), orderBy('date', 'desc')), snap => {
                const list = document.getElementById('list-requests');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isApprover = (data.requester === 'peipei' && currentUser === 'haoxuan') || (data.requester === 'haoxuan' && currentUser === 'peipei');
                    const statusColors = { 'pending': 'bg-yellow-100 text-yellow-700', 'approved': 'bg-green-100 text-green-700', 'rejected': 'bg-red-100 text-red-700' };
                    const statusText = { 'pending': 'å¾…ç°½æ ¸', 'approved': 'å·²åŒæ„', 'rejected': 'å·²é€€å›' };
                    
                    let actionButtons = '';
                    if (data.status === 'pending' && isApprover) {
                        actionButtons = `
                            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                                <button onclick="window.updateRequest('${d.id}', 'approved')" class="flex-1 bg-green-500 text-white py-1 rounded-lg text-sm">åŒæ„</button>
                                <button onclick="window.updateRequest('${d.id}', 'rejected')" class="flex-1 bg-red-400 text-white py-1 rounded-lg text-sm">å©‰æ‹’</button>
                            </div>`;
                    }

                    list.innerHTML += `
                        <div class="bg-white rounded-xl p-4 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-xs font-bold ${statusColors[data.status]}">
                                ${statusText[data.status]}
                            </div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">${data.requester === 'peipei' ? 'ğŸ€' : 'ğŸ»'}</span>
                                <span class="font-bold text-gray-800">${data.title}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2 bg-gray-50 p-2 rounded">${data.reason}</p>
                            <div class="text-xs text-gray-400">${new Date(data.date).toLocaleDateString()}</div>
                            ${actionButtons}
                        </div>`;
                });
            });
        }

        function renderWishes(snap, containerId, owner) {
            const list = document.getElementById(containerId);
            list.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                const isFulfilled = data.status === 'fulfilled';
                const isOwner = currentUser === owner;
                
                // Only owner can delete, but anyone can view. 
                // Toggle status: prompt implied "wishes have fulfilled mechanism". Let's allow clicking to toggle for owner.
                
                list.innerHTML += `
                    <div onclick="${isOwner ? `window.toggleWish('${owner}_wishes', '${d.id}', '${data.status}')` : ''}" 
                         class="aspect-square relative flex flex-col items-center justify-center p-3 rounded-2xl shadow-sm transition-all
                         ${isFulfilled ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700'} 
                         ${isOwner ? 'cursor-pointer active:scale-95' : ''}">
                        
                        ${isFulfilled ? '<div class="absolute inset-0 flex items-center justify-center bg-white/40 backdrop-blur-[1px] rounded-2xl"><span class="text-2xl font-bold text-green-500 transform -rotate-12 border-2 border-green-500 px-2 rounded">GET!</span></div>' : ''}
                        
                        <i class="fas fa-gift text-2xl mb-2 ${isFulfilled ? 'text-gray-300' : (owner === 'peipei' ? 'text-pink-400' : 'text-blue-400')}"></i>
                        <span class="text-center font-bold text-sm leading-tight">${data.title}</span>
                        ${isOwner ? `<button onclick="event.stopPropagation(); window.deleteItem('${owner}_wishes', '${d.id}')" class="absolute top-1 right-1 text-gray-300 hover:text-red-400 p-1"><i class="fas fa-times"></i></button>` : ''}
                    </div>`;
            });
        }

        // --- UI Logic ---
        
        let tempUser = null;

        window.selectUser = (user) => {
            tempUser = user;
            document.getElementById('btn-user-peipei').classList.remove('ring-4', 'ring-purple-300');
            document.getElementById('btn-user-haoxuan').classList.remove('ring-4', 'ring-blue-300');
            
            const btn = document.getElementById(`btn-user-${user}`);
            const color = user === 'peipei' ? 'ring-purple-300' : 'ring-blue-300';
            btn.classList.add('ring-4', color);
            
            const pinSec = document.getElementById('pin-section');
            pinSec.classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
            document.getElementById('pin-instruction').innerText = `è«‹è¼¸å…¥ ${user === 'peipei' ? 'ä½©ä½©' : 'æµ©è»’'} çš„ PIN ç¢¼`;
        };

        window.verifyPin = () => {
            const input = document.getElementById('pin-input').value;
            if (input === currentPins[tempUser]) {
                login(tempUser);
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ â¤ï¸");
                document.getElementById('pin-input').value = '';
            }
        };

        function login(user) {
            currentUser = user;
            document.body.classList.remove('theme-peipei', 'theme-haoxuan');
            document.body.classList.add(`theme-${user}`);
            
            // Background Theme
            if (user === 'haoxuan') {
                document.body.style.background = 'linear-gradient(135deg, #E0F2FE 0%, #A5F3FC 100%)'; // Light Blue
            } else {
                document.body.style.background = 'linear-gradient(135deg, #F3E8FF 0%, #E0E7FF 100%)'; // Pale Purple
            }

            // Update Header
            document.getElementById('current-user-display').innerText = `ç•¶å‰ç™»å…¥: ${user === 'peipei' ? 'ä½©ä½©' : 'æµ©è»’'}`;
            
            // Switch to Main App
            document.getElementById('login-page').classList.remove('active-page');
            document.getElementById('login-page').classList.add('hidden-page');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('main-app').classList.add('flex');

            switchTab('peipei'); // Default tab
        }

        window.switchTab = (tab) => {
            currentTab = tab;
            
            // Title
            const titles = {
                'peipei': 'ä½©ã®å°ˆå±¬',
                'haoxuan': 'è»’ã®å°ˆå±¬',
                'family': 'å®¶åº­é–‹æ”¯',
                'dream': 'å¤¢æƒ³åŸºé‡‘',
                'requests': 'éœ€æ±‚ç”³è«‹'
            };
            document.getElementById('header-title').innerText = titles[tab];

            // Views
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden-page'));
            document.getElementById(`view-${tab}`).classList.remove('hidden-page');

            // Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-purple-600', 'text-blue-600', 'font-bold');
                btn.querySelector('span:last-child').classList.remove('text-purple-600', 'text-blue-600');
            });
            const activeBtn = document.getElementById(`nav-${tab}`);
            const activeColor = currentUser === 'peipei' ? 'text-purple-600' : 'text-blue-600';
            activeBtn.classList.add(activeColor, 'font-bold');
            activeBtn.querySelector('span:last-child').classList.add(activeColor);
        };

        // --- Modals & Forms ---

        window.openModal = (type) => {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            let content = '';
            
            if (type === 'add-reimburse') {
                content = `
                    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in">
                        <h3 class="font-bold text-lg mb-4 text-center">æ–°å¢å ±éŠ·é …ç›®</h3>
                        <input id="inp-reimb-title" type="text" placeholder="é …ç›®åç¨±" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-purple-200">
                        <input id="inp-reimb-amount" type="number" placeholder="é‡‘é¡" class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-purple-200">
                        <div class="flex gap-2">
                            <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                            <button onclick="submitReimburse()" class="flex-1 py-2 bg-purple-500 text-white rounded-xl font-bold shadow-md">æ–°å¢</button>
                        </div>
                    </div>`;
            } else if (type === 'add-wish-peipei' || type === 'add-wish-haoxuan') {
                const isPei = type === 'add-wish-peipei';
                content = `
                    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in">
                        <h3 class="font-bold text-lg mb-4 text-center">è¨±ä¸‹é¡˜æœ› âœ¨</h3>
                        <input id="inp-wish-title" type="text" placeholder="æƒ³è¦ä»€éº¼..." class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-pink-200">
                        <div class="flex gap-2">
                            <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                            <button onclick="submitWish('${isPei ? 'peipei_wishes' : 'haoxuan_wishes'}')" class="flex-1 py-2 ${isPei ? 'bg-pink-500' : 'bg-blue-500'} text-white rounded-xl font-bold shadow-md">è¨±é¡˜</button>
                        </div>
                    </div>`;
            } else if (type === 'add-shopping') {
                content = `
                    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in">
                        <h3 class="font-bold text-lg mb-4 text-center">æ–°å¢å¾…è³¼</h3>
                        <input id="inp-shop-item" type="text" placeholder="è²·ä»€éº¼..." class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-green-200">
                        <div class="flex gap-2">
                            <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                            <button onclick="submitShopping()" class="flex-1 py-2 bg-green-500 text-white rounded-xl font-bold shadow-md">æ–°å¢</button>
                        </div>
                    </div>`;
            } else if (type === 'add-expense') {
                content = `
                    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in">
                        <h3 class="font-bold text-lg mb-4 text-center">è¨˜ä¸€ç­†</h3>
                        <input id="inp-exp-title" type="text" placeholder="é …ç›®" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-orange-200">
                        <input id="inp-exp-amount" type="number" placeholder="é‡‘é¡" class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-orange-200">
                        <div class="flex gap-2">
                            <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                            <button onclick="submitExpense()" class="flex-1 py-2 bg-orange-500 text-white rounded-xl font-bold shadow-md">ç´€éŒ„</button>
                        </div>
                    </div>`;
            } else if (type === 'add-dream') {
                content = `
                    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in">
                        <h3 class="font-bold text-lg mb-4 text-center">å¤¢æƒ³åŸºé‡‘ ğŸ’</h3>
                        <input id="inp-dream-note" type="text" placeholder="å‚™è¨» (å¦‚: å­˜å…¥è–ªæ°´)" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-200">
                        <input id="inp-dream-amount" type="number" placeholder="é‡‘é¡ (è² æ•¸ç‚ºæ”¯å‡º)" class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-200">
                        <div class="flex gap-2">
                            <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                            <button onclick="submitDream()" class="flex-1 py-2 bg-indigo-500 text-white rounded-xl font-bold shadow-md">ç¢ºå®š</button>
                        </div>
                    </div>`;
            } else if (type === 'add-request') {
                content = `
                    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in">
                        <h3 class="font-bold text-lg mb-4 text-center">æå‡ºç”³è«‹ ğŸ“</h3>
                        <input id="inp-req-title" type="text" placeholder="éœ€æ±‚äº‹é …" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-gray-200">
                        <textarea id="inp-req-reason" rows="3" placeholder="åŸå› ..." class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-gray-200"></textarea>
                        <div class="flex gap-2">
                            <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                            <button onclick="submitRequest()" class="flex-1 py-2 bg-gray-700 text-white rounded-xl font-bold shadow-md">é€å‡º</button>
                        </div>
                    </div>`;
            }

            overlay.innerHTML = content;
        };

        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.add('hidden');
        };

        window.openSettings = () => {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            overlay.innerHTML = `
                <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-fade-in text-center">
                    <h3 class="font-bold text-lg mb-4">ä¿®æ”¹ PIN ç¢¼</h3>
                    <p class="text-sm text-gray-500 mb-2">ä¿®æ”¹ ${currentUser === 'peipei' ? 'ä½©ä½©' : 'æµ©è»’'} çš„å¯†ç¢¼</p>
                    <input id="inp-new-pin" type="text" maxlength="4" placeholder="æ–° 4 ä½ PIN" class="w-full mb-4 p-3 text-center text-xl tracking-widest bg-gray-50 rounded-xl border border-gray-200">
                    <div class="flex gap-2">
                        <button onclick="closeModal()" class="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                        <button onclick="saveNewPin()" class="flex-1 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-xl font-bold shadow-md">å„²å­˜</button>
                    </div>
                </div>`;
        };

        // --- CRUD Actions ---

        window.submitReimburse = async () => {
            if (currentUser !== 'peipei') { alert("åªæœ‰ä½©ä½©å¯ä»¥æ–°å¢å ±éŠ·å–”ï¼"); closeModal(); return; }
            const title = document.getElementById('inp-reimb-title').value;
            const amount = document.getElementById('inp-reimb-amount').value;
            if(!title || !amount) return;
            await addDoc(getColl('reimbursements'), { title, amount: parseInt(amount), status: 'pending', date: Date.now() });
            closeModal();
        };

        window.submitWish = async (collName) => {
            if (collName === 'peipei_wishes' && currentUser !== 'peipei') { alert("é€™æ˜¯ä½©ä½©çš„è¨±é¡˜æ± ï¼"); return; }
            if (collName === 'haoxuan_wishes' && currentUser !== 'haoxuan') { alert("é€™æ˜¯æµ©è»’çš„è¨±é¡˜æ± ï¼"); return; }
            const title = document.getElementById('inp-wish-title').value;
            if(!title) return;
            await addDoc(getColl(collName), { title, status: 'active', date: Date.now() });
            closeModal();
        };

        window.toggleWish = async (coll, id, currentStatus) => {
            const newStatus = currentStatus === 'active' ? 'fulfilled' : 'active';
            await updateDoc(doc(getColl(coll), id), { status: newStatus });
        };

        window.submitShopping = async () => {
            const item = document.getElementById('inp-shop-item').value;
            if(!item) return;
            await addDoc(getColl('shopping_list'), { item, checked: false, date: Date.now() });
            closeModal();
        };

        window.toggleCheck = async (coll, id, checked) => {
            await updateDoc(doc(getColl(coll), id), { checked });
        };

        window.submitExpense = async () => {
            const title = document.getElementById('inp-exp-title').value;
            const amount = document.getElementById('inp-exp-amount').value;
            if(!title || !amount) return;
            await addDoc(getColl('family_expenses'), { title, amount: parseInt(amount), date: Date.now() });
            closeModal();
        };

        window.submitDream = async () => {
            const note = document.getElementById('inp-dream-note').value;
            const amount = document.getElementById('inp-dream-amount').value;
            if(!note || !amount) return;
            await addDoc(getColl('dream_fund'), { note, amount: parseInt(amount), date: Date.now() });
            closeModal();
        };

        window.submitRequest = async () => {
            const title = document.getElementById('inp-req-title').value;
            const reason = document.getElementById('inp-req-reason').value;
            if(!title) return;
            await addDoc(getColl('requests'), { 
                title, 
                reason, 
                status: 'pending', 
                requester: currentUser, 
                date: Date.now() 
            });
            closeModal();
        };

        window.updateRequest = async (id, status) => {
            await updateDoc(doc(getColl('requests'), id), { status });
        };

        window.payReimburse = async (id) => {
            // No need for extra PIN check here as user logged in as Haoxuan
            if(confirm("ç¢ºå®šè¦æ ¸éŠ·æ­¤é …ç›®å—ï¼Ÿ")) {
                await updateDoc(doc(getColl('reimbursements'), id), { status: 'paid' });
            }
        };

        window.deleteItem = async (coll, id) => {
            if(confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
                await deleteDoc(doc(getColl(coll), id));
            }
        };

        window.saveNewPin = async () => {
            const newPin = document.getElementById('inp-new-pin').value;
            if(!newPin || newPin.length !== 4) { alert("è«‹è¼¸å…¥ 4 ä½æ•¸ PIN ç¢¼"); return; }
            
            const updates = {};
            updates[currentUser] = newPin;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), updates, { merge: true });
            currentPins[currentUser] = newPin; // optimistic update
            alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚");
            closeModal();
        };

        // Start
        init();

    </script>
</body>
</html>

